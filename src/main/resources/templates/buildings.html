<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta charset="UTF-8" />
    <title>Управление на сгради - Анализ на апартаменти</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="/static/css/app.css" rel="stylesheet" />
    <style>
        .current-building-switch .form-check-input {
            width: 2.25rem;
            height: 1.25rem;
            cursor: pointer;
        }
        .current-building-switch .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
    </style>
    <!-- Sidebar Styles -->
    <th:block th:replace="~{fragments/sidebar :: sidebarStyles}"></th:block>
</head>
<body>
    <!-- Sidebar Toggle Button (Mobile) -->
    <th:block th:replace="~{fragments/sidebar :: sidebarToggle}"></th:block>
    
    <!-- Sidebar -->
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
    <div class="container-fluid py-4">
        <!-- Съобщение за грешка -->
        <div class="alert alert-danger alert-dismissible fade show" role="alert" th:if="${error != null}">
            <i class="bi bi-exclamation-triangle me-2"></i><span th:text="${error}">Грешка</span>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        <!-- Header -->
        <div class="d-flex flex-wrap justify-content-between align-items-center mb-3">
            <div>
                <h3 class="mb-1">Сгради</h3>
                <div class="text-muted small">Управление и преглед на сградите в системата</div>
            </div>
            <div>
                <a th:href="@{/buildings/add}" class="btn btn-success">
                    <i class="bi bi-plus-circle me-2"></i>Добави сграда
                </a>
            </div>
        </div>

        <!-- Key Stats -->
        <div class="row g-3 mb-4">
            <div class="col-md-4">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small">Общ брой сгради</div>
                        <div class="fs-3 fw-semibold" th:text="${buildingsCount != null ? buildingsCount : 0}">0</div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <div class="card shadow-sm h-100">
                    <div class="card-body">
                        <div class="text-muted small">Активна сграда</div>
                        <div class="fs-5 fw-semibold" th:if="${currentBuilding != null}" th:text="${currentBuilding.name}">Сграда</div>
                        <div class="text-muted" th:if="${currentBuilding == null}">Няма активна сграда</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-3 mb-4">
            <div class="col-lg-8">
                <div class="card small">
                    <div class="card-header d-flex flex-wrap gap-2 justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            <i class="bi bi-buildings me-2"></i>Всички сгради
                            <span class="badge bg-primary ms-2" th:text="'(' + ${buildingsCount != null ? buildingsCount : 0} + ')'">(0)</span>
                        </h6>
                        <div class="input-group input-group-sm" style="max-width: 320px;">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="buildingFilter" placeholder="Търсене по име, адрес, етап">
                            <button class="btn btn-outline-secondary" type="button" id="clearBuildingFilter">Изчисти</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered table-hover" id="buildingsTable">
                                <thead class="table-light">
                                <tr>
                                    <th>Обект</th>
                                    <th>Площ</th>
                                    <th>Дата на създаване</th>
                                    <th>Етап</th>
                                    <th>Действия</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="building : ${buildings}"
                                    class="building-row"
                                    th:attr="data-name=${building.name},data-apartments=${building.apartmentsCount},data-garages=${building.garagesCount},data-basements=${building.basementsCount},data-parking=${building.parkingSpacesCount},data-commercial=${building.commercialSpacesCount},data-total=${building.totalCount}">
                                    <td>
                                        <strong th:text="${building.name}">Име на сграда</strong>
                                        <span class="badge bg-info ms-2" th:if="${currentBuilding != null and currentBuilding.id == building.id}">Текуща</span>
                                    </td>
                                    <td th:text="${building.address != null ? building.address : '-'}">Адрес</td>
                                    <td th:text="${building.createdAt != null ? #temporals.format(building.createdAt, 'dd.MM.yyyy HH:mm') : '-'}">Дата</td>
                                    <td>
                                        <span th:text="${(building.stage != null and !building.stage.isEmpty()) ? building.stage : '-'}">-</span>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <form th:action="@{/buildings/set-current}" method="POST" class="d-inline">
                                                <input type="hidden" name="buildingId" th:value="${building.id}" />
                                                <div class="form-check form-switch m-0 current-building-switch">
                                                    <input class="form-check-input current-building-radio" type="radio" name="currentBuilding"
                                                           th:value="${building.id}"
                                                           th:checked="${currentBuilding != null and currentBuilding.id == building.id}"
                                                           title="Избери за работа" aria-label="Избери сграда за работа">
                                                </div>
                                            </form>
                                            <a th:href="@{/buildings/{id}(id=${building.id})}"
                                               class="btn btn-sm btn-primary" title="Преглед с всички детайли">
                                                <i class="bi bi-eye me-1"></i>Преглед
                                            </a>
                                            <a th:href="@{/buildings/edit/{id}(id=${building.id})}"
                                               class="btn btn-sm btn-outline-warning" title="Редактирай">
                                                <i class="bi bi-pencil"></i>
                                            </a>
                                            <form th:action="@{/buildings/delete}" method="POST" class="d-inline">
                                                <input type="hidden" name="buildingId" th:value="${building.id}" />
                                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                                        title="Изтрий"
                                                        onclick="return confirm('Сигурни ли сте, че искате да изтриете сградата?')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="text-center py-4" th:if="${buildings == null or buildings.isEmpty()}">
                            <i class="bi bi-buildings text-muted" style="font-size: 3rem;"></i>
                            <h5 class="text-muted mt-3">Няма сгради</h5>
                            <p class="text-muted">Добавете първата сграда за да започнете работа.</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="card" id="buildingInfoCard">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="fw-semibold">
                            <i class="bi bi-building me-2"></i>Информация за сграда
                        </div>
                        <a id="buildingInfoViewLink" th:if="${currentBuilding != null}" th:href="@{/buildings/{id}(id=${currentBuilding.id})}" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-eye me-1"></i>Преглед
                        </a>
                    </div>
                    <div class="card-body small">
                        <div class="mb-2 text-muted">Име</div>
                        <div class="fw-semibold mb-3" id="infoName" th:text="${currentBuilding != null ? currentBuilding.name : '-'}">-</div>

                        <div class="text-muted mb-2">Обекти</div>
                        <ul class="list-group list-group-flush small mb-3">
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Апартаменти</span>
                                <span class="fw-semibold" id="infoApartments" th:text="${apartmentsCount != null ? apartmentsCount : 0}">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Гаражи</span>
                                <span class="fw-semibold" id="infoGarages" th:text="${garagesCount != null ? garagesCount : 0}">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Мазета</span>
                                <span class="fw-semibold" id="infoBasements" th:text="${basementsCount != null ? basementsCount : 0}">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Паркоместа</span>
                                <span class="fw-semibold" id="infoParking" th:text="${parkingSpacesCount != null ? parkingSpacesCount : 0}">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Търговски</span>
                                <span class="fw-semibold" id="infoCommercial" th:text="${commercialSpacesCount != null ? commercialSpacesCount : 0}">0</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between">
                                <span>Общо</span>
                                <span class="fw-semibold" id="infoTotal" th:text="${(apartmentsCount != null ? apartmentsCount : 0) + (garagesCount != null ? garagesCount : 0) + (basementsCount != null ? basementsCount : 0) + (parkingSpacesCount != null ? parkingSpacesCount : 0) + (commercialSpacesCount != null ? commercialSpacesCount : 0)}">0</span>
                            </li>
                        </ul>

                        <div class="text-muted" id="infoHint" th:if="${currentBuilding == null}">
                            Изберете сграда от списъка или задръжте курсора върху нея.
                        </div>
                    </div>
                </div>
            </div>
        </div>

 </div>

 <!-- Bootstrap JS -->
 <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
 <!-- jQuery -->
 <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
 <!-- DataTables JS -->
 <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
 <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
 
 <script th:inline="none">
 $(document).ready(function() {
 // Инициализация на DataTables
 if ($('#buildingsTable').length) {
 const table = $('#buildingsTable').DataTable({
 language: {
 // Използваме вградени български настройки
 "sProcessing": "Обработване...",
 "sLengthMenu": "Покажи _MENU_ записа",
 "sZeroRecords": "Не са намерени съответстващи записи",
 "sInfo": "Показване на _START_ до _END_ от _TOTAL_ записа",
 "sInfoEmpty": "Показване на 0 до 0 от 0 записа",
 "sInfoFiltered": "(филтрирани от _MAX_ общо записа)",
 "sSearch": "Търсене:",
 "sEmptyTable": "Няма данни в таблицата",
 "sFirst": "Първа",
 "sPrevious": "Предишна",
 "sNext": "Следваща",
 "sLast": "Последна"
 },
 order: [[2, 'desc']], // Сортиране по дата на създаване (най-новите първо)
 pageLength: 10,
 scrollX: true,
 responsive: true,
 searching: false,
 lengthChange: false,
 dom: 'rtip'
 });

 const filterInput = document.getElementById('buildingFilter');
 const clearBtn = document.getElementById('clearBuildingFilter');
 if (filterInput) {
     $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
         if (settings.nTable.id !== 'buildingsTable') return true;
         const query = (filterInput.value || '').toLowerCase().trim();
         if (!query) return true;
         const row = table.row(dataIndex).node();
         const name = (row.getAttribute('data-name') || '').toLowerCase();
         const address = (row.getAttribute('data-address') || '').toLowerCase();
         const stage = (row.getAttribute('data-stage') || '').toLowerCase();
         const hay = `${name} ${address} ${stage}`;
         const terms = query.split(/\s+/).filter(Boolean);
         return terms.every(term => hay.includes(term));
     });

     filterInput.addEventListener('input', function() {
         table.draw();
     });
 }

 if (clearBtn) {
     clearBtn.addEventListener('click', function() {
         if (filterInput) {
             filterInput.value = '';
         }
         table.draw();
     });
 }

 // Submit on radio change for current building selection
 document.querySelectorAll('.current-building-radio').forEach(function(radio) {
     radio.addEventListener('change', function() {
         if (this.form) {
             this.form.submit();
         }
     });
 });

 // Hover preview in "Информация за сграда"
 const infoName = document.getElementById('infoName');
 const infoApartments = document.getElementById('infoApartments');
 const infoGarages = document.getElementById('infoGarages');
 const infoBasements = document.getElementById('infoBasements');
 const infoParking = document.getElementById('infoParking');
 const infoCommercial = document.getElementById('infoCommercial');
 const infoTotal = document.getElementById('infoTotal');
 const infoHint = document.getElementById('infoHint');
 const infoViewLink = document.getElementById('buildingInfoViewLink');

 const defaultInfo = {
     name: infoName ? infoName.textContent.trim() : '-',
     apartments: infoApartments ? infoApartments.textContent.trim() : '0',
     garages: infoGarages ? infoGarages.textContent.trim() : '0',
     basements: infoBasements ? infoBasements.textContent.trim() : '0',
     parking: infoParking ? infoParking.textContent.trim() : '0',
     commercial: infoCommercial ? infoCommercial.textContent.trim() : '0',
     total: infoTotal ? infoTotal.textContent.trim() : '0',
     hasCurrent: !!infoViewLink
 };

 function setInfo(data) {
     if (infoName) infoName.textContent = data.name || '-';
     if (infoApartments) infoApartments.textContent = data.apartments || '0';
     if (infoGarages) infoGarages.textContent = data.garages || '0';
     if (infoBasements) infoBasements.textContent = data.basements || '0';
     if (infoParking) infoParking.textContent = data.parking || '0';
     if (infoCommercial) infoCommercial.textContent = data.commercial || '0';
     if (infoTotal) infoTotal.textContent = data.total || '0';
     if (infoHint) infoHint.style.display = 'none';
 }

 function resetInfo() {
     if (defaultInfo.hasCurrent) {
         setInfo(defaultInfo);
     } else if (infoHint) {
         if (infoName) infoName.textContent = '-';
         if (infoApartments) infoApartments.textContent = '0';
         if (infoGarages) infoGarages.textContent = '0';
         if (infoBasements) infoBasements.textContent = '0';
         if (infoParking) infoParking.textContent = '0';
         if (infoCommercial) infoCommercial.textContent = '0';
         if (infoTotal) infoTotal.textContent = '0';
         infoHint.style.display = '';
     }
 }

 document.querySelectorAll('.building-row').forEach(function(row) {
     row.addEventListener('mouseenter', function() {
         setInfo({
             name: row.getAttribute('data-name') || '-',
             apartments: row.getAttribute('data-apartments') || '0',
             garages: row.getAttribute('data-garages') || '0',
             basements: row.getAttribute('data-basements') || '0',
             parking: row.getAttribute('data-parking') || '0',
             commercial: row.getAttribute('data-commercial') || '0',
             total: row.getAttribute('data-total') || '0'
         });
     });
     row.addEventListener('mouseleave', function() {
         resetInfo();
     });
 });
 }
    });
    </script>
    </div>
    </div> <!-- End main-content -->
    
    <!-- Sidebar Script -->
    <th:block th:replace="~{fragments/sidebar :: sidebarScript}"></th:block>
</body>
</html>
