<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Детайли за клиент</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="/static/css/app.css" rel="stylesheet" />
    <!-- Sidebar Styles -->
    <th:block th:replace="~{fragments/sidebar :: sidebarStyles}"></th:block>
    <style>
        .stat-card {
            transition: transform 0.2s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .payment-badge {
            font-size: 0.75rem;
        }
        .progress {
            height: 20px;
        }
        .apartment-card {
            transition: border 0.3s ease, box-shadow 0.3s ease;
        }
        .delay-indicator {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Payment history collapse styles */
        .collapse-icon {
            transition: transform 0.3s ease;
        }
        .collapsed .collapse-icon {
            transform: rotate(0deg);
        }
        .collapse-icon:not(.collapsed) {
            transform: rotate(180deg);
        }
        [data-bs-toggle="collapse"]:not(.collapsed) .collapse-icon {
            transform: rotate(180deg);
        }
        .card-header .btn-link:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        .card-header .btn-link:focus {
            box-shadow: none;
        }
    </style>
</head>
<body>
    <!-- Sidebar Toggle Button (Mobile) -->
    <th:block th:replace="~{fragments/sidebar :: sidebarToggle}"></th:block>
    
    <!-- Sidebar -->
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
        <div class="container-fluid py-4">
            <!-- Breadcrumb -->
            <nav aria-label="breadcrumb" class="mb-4">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a th:href="@{/clients}">Клиенти</a></li>
                    <li class="breadcrumb-item active" th:text="${client.name}">Клиент</li>
                </ol>
            </nav>

            <div class="row">
                <!-- Left Sidebar - Client Information -->
                <div class="col-md-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0">
                                <i class="bi bi-person"></i> Информация за клиента
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <h4 class="text-primary" th:text="${client.name}">Име на клиент</h4>
                                <small class="text-muted">ID: <span th:text="${client.id}"></span></small>
                            </div>

                            <hr />

                            <div class="mb-3" th:if="${client.phone != null and !client.phone.isEmpty()}">
                                <h6><i class="bi bi-telephone text-success"></i> Телефон</h6>
                                <a th:href="@{'tel:' + ${client.phone}}" class="text-decoration-none" th:text="${client.phone}">+359 888 123 456</a>
                            </div>
                            <div class="mb-3" th:unless="${client.phone != null and !client.phone.isEmpty()}">
                                <h6><i class="bi bi-telephone text-muted"></i> Телефон</h6>
                                <span class="text-muted">Не е посочен</span>
                            </div>

                            <div class="mb-3" th:if="${client.email != null and !client.email.isEmpty()}">
                                <h6><i class="bi bi-envelope text-primary"></i> Имейл</h6>
                                <a th:href="@{'mailto:' + ${client.email}}" class="text-decoration-none" th:text="${client.email}">client@example.com</a>
                            </div>
                            <div class="mb-3" th:unless="${client.email != null and !client.email.isEmpty()}">
                                <h6><i class="bi bi-envelope text-muted"></i> Имейл</h6>
                                <span class="text-muted">Не е посочен</span>
                            </div>

                            <div class="mb-3" th:if="${client.address != null and !client.address.isEmpty()}">
                                <h6><i class="bi bi-geo-alt text-warning"></i> Адрес</h6>
                                <span th:text="${client.address}">Адрес</span>
                            </div>

                            <div class="mb-3" th:if="${client.notes != null and !client.notes.isEmpty()}">
                                <h6><i class="bi bi-sticky text-warning"></i> Бележки</h6>
                                <p class="text-muted" th:text="${client.notes}">Бележки</p>
                            </div>

                            <hr />

                            <div class="mb-3">
                                <small class="text-muted">
                                    <i class="bi bi-calendar-plus"></i> Създаден:
                                    <span th:text="${#temporals.format(client.createdAt, 'dd.MM.yyyy HH:mm')}"></span>
                                    <span th:if="${client.updatedAt != null}">
                                        <br /><i class="bi bi-calendar-check"></i> Последна промяна:
                                        <span th:text="${#temporals.format(client.updatedAt, 'dd.MM.yyyy HH:mm')}"></span>
                                    </span>
                                </small>
                            </div>

                            <div class="d-grid gap-2">
                                <a th:href="@{/clients/edit/{id}(id=${client.id})}" class="btn btn-warning">
                                    <i class="bi bi-pencil"></i> Редактирай
                                </a>
                                <a th:href="@{/clients}" class="btn btn-secondary">
                                    <i class="bi bi-arrow-left"></i> Назад към списъка
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content - Apartments and Payments -->
                <div class="col-md-8">
                    <!-- Statistics Cards -->
                    <div class="row mb-4">
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card bg-primary text-white">
                                <div class="card-body text-center">
                                    <h4 th:text="${apartmentsCount}">0</h4>
                                    <small>Имота</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card bg-info text-white">
                                <div class="card-body text-center">
                                    <h4 th:text="${#numbers.formatDecimal(totalValue, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</h4>
                                    <small>Обща стойност</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card bg-success text-white">
                                <div class="card-body text-center">
                                    <h4 th:text="${#numbers.formatDecimal(totalPaid, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</h4>
                                    <small>Платено</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card stat-card text-white" th:classappend="${remaining.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? 'bg-warning' : 'bg-secondary'">
                                <div class="card-body text-center">
                                    <h4 th:text="${#numbers.formatDecimal(remaining, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</h4>
                                    <small>Остатък</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Payment Methods Breakdown -->
                    <div class="row mb-4" th:if="${totalBankPayments.compareTo(T(java.math.BigDecimal).ZERO) > 0 or totalCashPayments.compareTo(T(java.math.BigDecimal).ZERO) > 0}">
                        <div class="col-12">
                            <div class="card border-light">
                                <div class="card-body py-2">
                                    <h6 class="card-title mb-2">
                                        <i class="bi bi-cash-stack me-2"></i>Методи на плащане
                                    </h6>
                                    <div class="row text-center">
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="bi bi-bank text-primary me-2"></i>
                                                <span class="fw-bold text-primary" th:text="${#numbers.formatDecimal(totalBankPayments, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span>
                                                <small class="text-muted ms-2">по банка</small>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex align-items-center justify-content-center">
                                                <i class="bi bi-cash text-success me-2"></i>
                                                <span class="fw-bold text-success" th:text="${#numbers.formatDecimal(totalCashPayments, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span>
                                                <small class="text-muted ms-2">в брой</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apartments List -->
                    <div th:if="${client.apartments != null and !client.apartments.isEmpty()}">
                        <div class="card shadow-sm">
                            <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                                <h5 class="mb-0">
                                    <i class="bi bi-building"></i> Закупени обекти
                                </h5>
                                <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#addPurchaseModal">
                                    <i class="bi bi-plus-circle"></i> Добави покупка
                                </button>
                            </div>
                            <div class="card-body">
                                <div th:each="apt : ${client.apartments}" class="card mb-3 border apartment-card" 
                                     th:data-apt-id="${apt.id}"
                                     th:data-has-plan="${apt.paymentPlan != null}"
                                     th:data-stage="${apt.stage}">
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-5">
                                                <h6 class="card-title">
                                                    <i class="bi bi-house text-primary"></i> 
                                                    <span th:text="${apt.buildingName != null ? apt.buildingName : (apt.building != null ? apt.building.name : 'Неизвестна сграда')} + ' - Ап. ' + ${apt.apartmentNumber}">Сграда - Ап. 1</span>
                                                </h6>
                                                <p class="card-text">
                                                    <small class="text-muted">
                                                        <i class="bi bi-rulers"></i> 
                                                        <span th:text="${#numbers.formatDecimal(apt.area, 0, 'COMMA', 2, 'POINT')}">0.00</span> кв.м |
                                                        <i class="bi bi-currency-euro"></i> 
                                                        <span th:text="${#numbers.formatDecimal(apt.pricePerM2, 0, 'COMMA', 2, 'POINT')}">0.00</span> €/кв.м |
                                                        <i class="bi bi-box"></i> 
                                                        <span th:text="${apt.stage != null ? apt.stage : 'Не посочен'}">Етап</span>
                                                    </small>
                                                </p>
                                                <div th:if="${apt.notes != null and !apt.notes.isEmpty()}">
                                                    <small class="text-muted">
                                                        <i class="bi bi-sticky"></i> <span th:text="${apt.notes}">Бележки</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-5">
                                                <div class="text-end">
                                                    <h5 class="text-primary" th:text="${#numbers.formatDecimal(apt.totalPrice, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</h5>
                                                    <div class="progress mb-2" style="height: 20px;">
                                                        <div class="progress-bar" 
                                                             th:classappend="${apt.totalPrice != null and apt.totalPrice.compareTo(T(java.math.BigDecimal).ZERO) > 0 and apt.getTotalPaid().compareTo(apt.totalPrice) >= 0} ? 'bg-success' : 
                                                                              (${apt.totalPrice != null and apt.totalPrice.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? 'bg-info' : 'bg-secondary')"
                                                             th:with="paidAmount=${apt.getTotalPaid() != null ? apt.getTotalPaid() : T(java.math.BigDecimal).ZERO},
                                                                      totalAmount=${apt.totalPrice != null ? apt.totalPrice : T(java.math.BigDecimal).ZERO},
                                                                      percentage=${totalAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0 ? 
                                                                                  paidAmount.divide(totalAmount, 4, T(java.math.RoundingMode).HALF_UP).multiply(T(java.math.BigDecimal).TEN).multiply(T(java.math.BigDecimal).TEN) : 
                                                                                  T(java.math.BigDecimal).ZERO}"
                                                             th:style="${totalAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? 
                                                                        ('width: ' + ${#numbers.formatDecimal(percentage, 0, 'POINT', 0, 'POINT')} + '%;') : 
                                                                        'width: 0%;'">
                                                            <span th:text="${totalAmount.compareTo(T(java.math.BigDecimal).ZERO) > 0} ? 
                                                                          (${#numbers.formatDecimal(percentage, 0, 'POINT', 0, 'POINT')} + '%') : '0%'">0%</span>
                                                        </div>
                                                    </div>
                                                    <small class="text-muted">
                                                        Платено: <span class="text-success fw-bold" th:text="${#numbers.formatDecimal(apt.getTotalPaid(), 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span> |
                                                        Остатък: <span class="text-warning fw-bold" th:text="${#numbers.formatDecimal(apt.getRemainingPayment(), 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</span>
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="col-md-2 text-end">
                                                <div class="btn-group-vertical" role="group">
                                                    <button type="button" class="btn btn-sm btn-success mb-2 add-payment-btn" 
                                                            th:data-apt-id="${apt.id}"
                                                            th:data-apt-number="${apt.apartmentNumber}"
                                                            th:data-building-name="${apt.buildingName != null ? apt.buildingName : (apt.building != null ? apt.building.name : 'Неизвестна сграда')}">
                                                        <i class="bi bi-cash-coin"></i> Добави плащане
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-warning mb-2 edit-purchase-btn" 
                                                            th:data-apt-id="${apt.id}"
                                                            th:data-apt-number="${apt.apartmentNumber}"
                                                            th:data-total-price="${apt.totalPrice}"
                                                            th:data-prelim="${apt.paymentPlan != null ? apt.paymentPlan.preliminaryContractAmount : 0}"
                                                            th:data-akt14="${apt.paymentPlan != null ? apt.paymentPlan.akt14Amount : 0}"
                                                            th:data-akt15="${apt.paymentPlan != null ? apt.paymentPlan.akt15Amount : 0}"
                                                            th:data-akt16="${apt.paymentPlan != null ? apt.paymentPlan.akt16Amount : 0}">
                                                        <i class="bi bi-pencil"></i> Редактирай
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger delete-purchase-btn" 
                                                            th:data-apt-id="${apt.id}"
                                                            th:data-apt-number="${apt.apartmentNumber}">
                                                        <i class="bi bi-trash"></i> Изтрий
                                                    </button>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Payment History for this Apartment -->
                                        <div class="row mt-3" th:if="${apt.payments != null and !apt.payments.isEmpty()}">
                                            <div class="col-12">
                                                <div class="card border-light">
                                                    <div class="card-header py-2 bg-light">
                                                        <h6 class="mb-0">
                                                            <button class="btn btn-link text-decoration-none text-dark p-0 w-100 text-start d-flex justify-content-between align-items-center collapsed" 
                                                                    type="button" 
                                                                    data-bs-toggle="collapse" 
                                                                    th:data-bs-target="${'#paymentHistory-' + apt.id}" 
                                                                    aria-expanded="false" 
                                                                    th:aria-controls="${'paymentHistory-' + apt.id}">
                                                                <span>
                                                                    <i class="bi bi-clock-history me-2"></i>История на плащанията
                                                                    <span class="badge bg-secondary ms-2" th:text="${apt.payments.size()}">0</span>
                                                                </span>
                                                                <i class="bi bi-chevron-down collapse-icon"></i>
                                                            </button>
                                                        </h6>
                                                    </div>
                                                    <div class="collapse" th:id="${'paymentHistory-' + apt.id}">
                                                        <div class="card-body py-2">
                                                        <div th:each="payment, iterStat : ${apt.payments}" th:if="${iterStat.index < 5}" class="card border-light mb-2">
                                                            <div class="card-body py-2">
                                                                <div class="d-flex justify-content-between align-items-start mb-1">
                                                                    <div class="flex-grow-1">
                                                                        <small class="fw-bold text-primary" th:text="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 2, 'POINT')} + ' €'">0.00 €</small>
                                                                        <br />
                                                                        <small class="text-muted" th:text="${#temporals.format(payment.paymentDate, 'dd.MM.yyyy')}">Дата</small>
                                                                    </div>
                                                                    <div class="text-end me-2">
                                                                        <span class="badge" 
                                                                              th:classappend="${payment.paymentMethod == 'Банка' or payment.paymentMethod == 'Bank Transfer' or payment.paymentMethod == 'Bank'} ? 'bg-primary' : 'bg-success'"
                                                                              style="font-size: 0.7em;">
                                                                            <i th:classappend="${payment.paymentMethod == 'Банка' or payment.paymentMethod == 'Bank Transfer' or payment.paymentMethod == 'Bank'} ? 'bi bi-bank' : 'bi bi-cash'"></i>
                                                                            <span th:text="${payment.paymentMethod != null ? payment.paymentMethod : 'Не посочен'}">Метод</span>
                                                                        </span>
                                                                    </div>
                                                                    <div class="btn-group-vertical btn-group-sm">
                                                                        <button type="button" class="btn btn-sm btn-outline-primary edit-payment-btn" 
                                                                                th:data-payment-id="${payment.id}"
                                                                                th:data-apt-id="${apt.id}"
                                                                                th:data-apt-number="${apt.apartmentNumber}"
                                                                                th:data-building-name="${apt.buildingName != null ? apt.buildingName : (apt.building != null ? apt.building.name : 'Неизвестна сграда')}"
                                                                                th:data-amount="${payment.amount}"
                                                                                th:data-date="${#temporals.format(payment.paymentDate, 'yyyy-MM-dd')}"
                                                                                th:data-method="${payment.paymentMethod}"
                                                                                th:data-stage="${payment.paymentStage}"
                                                                                th:data-invoice="${payment.invoiceNumber}"
                                                                                th:data-is-deposit="${payment.isDeposit}"
                                                                                th:data-notes="${payment.notes}"
                                                                                title="Редактирай плащане">
                                                                            <i class="bi bi-pencil"></i>
                                                                        </button>
                                                                        <button type="button" class="btn btn-sm btn-outline-danger delete-payment-btn" 
                                                                                th:data-payment-id="${payment.id}"
                                                                                th:data-amount="${#numbers.formatDecimal(payment.amount, 0, 'COMMA', 2, 'POINT')}"
                                                                                th:data-date="${#temporals.format(payment.paymentDate, 'dd.MM.yyyy')}"
                                                                                title="Изтрий плащане">
                                                                            <i class="bi bi-trash"></i>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                                <div class="mt-1" th:if="${payment.invoiceNumber != null and !payment.invoiceNumber.isEmpty()}">
                                                                    <small class="text-muted">
                                                                        <i class="bi bi-receipt"></i> <span th:text="'Фактура: ' + ${payment.invoiceNumber}">Фактура</span>
                                                                    </small>
                                                                </div>
                                                                <div class="mt-1" th:if="${payment.paymentStage != null and !payment.paymentStage.isEmpty()}">
                                                                    <span class="badge bg-info" style="font-size: 0.7em;">
                                                                        <i class="bi bi-tag"></i> <span th:text="${payment.paymentStage}">Етап</span>
                                                                    </span>
                                                                </div>
                                                                <div class="mt-1" th:if="${payment.isDeposit != null and payment.isDeposit}">
                                                                    <span class="badge bg-warning" style="font-size: 0.7em;">
                                                                        <i class="bi bi-cash-stack"></i> Капаро
                                                                    </span>
                                                                </div>
                                                                <div class="mt-1" th:if="${payment.notes != null and !payment.notes.isEmpty()}">
                                                                    <small class="text-muted">
                                                                        <i class="bi bi-sticky"></i> <span th:text="${payment.notes}">Бележки</span>
                                                                    </small>
                                                                </div>
                                                            </div>
                                                        </div>
                                                            <div class="text-center mt-2" th:if="${apt.payments.size() > 5}">
                                                                <small class="text-muted">
                                                                    И още <span th:text="${apt.payments.size() - 5}">0</span> плащания...
                                                                </small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Empty State -->
                    <div th:unless="${client.apartments != null and !client.apartments.isEmpty()}">
                        <div class="card shadow-sm">
                            <div class="card-body text-center">
                                <div class="py-5">
                                    <i class="bi bi-cart text-muted" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted mt-3">Няма покупки</h4>
                                    <p class="text-muted">Клиентът все още няма покупки.</p>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPurchaseModal">
                                        <i class="bi bi-plus-circle"></i> Добави покупка
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Edit Purchase Modal -->
        <div class="modal fade" id="editPurchaseModal" tabindex="-1" aria-labelledby="editPurchaseModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editPurchaseModalLabel">
                            <i class="bi bi-pencil me-2"></i>Редактирай покупка
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="editAptId" />
                        
                        <div class="alert alert-info">
                            <strong id="editAptNumber"></strong>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-currency-euro"></i> Обща цена (€) *</label>
                            <input type="number" class="form-control" id="editTotalPrice" step="0.01" min="0.01" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label"><i class="bi bi-tag"></i> Пакет за плащане *</label>
                            <select class="form-select" id="editPaymentPackage" required>
                                <option value="">Изберете пакет</option>
                                <option value="standard">Стандартен</option>
                                <option value="balanced">Балансиран</option>
                                <option value="optimal">Оптимален</option>
                                <option value="investment">Инвестиционен</option>
                                <option value="profitable">Печеливш</option>
                                <option value="custom">Индивидуален</option>
                            </select>
                        </div>
                        
                        <div id="editCustomPercentages" style="display: none;">
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Общият процент трябва да е 100%
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label>Предварителен договор (%)</label>
                                    <input type="number" class="form-control edit-custom-perc" id="editPrelimPerc" step="0.1" min="0" max="100" value="30">
                                </div>
                                <div class="col-md-6">
                                    <label>Акт 14 (%)</label>
                                    <input type="number" class="form-control edit-custom-perc" id="editAkt14Perc" step="0.1" min="0" max="100" value="30">
                                </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-md-6">
                                    <label>Акт 15 (%)</label>
                                    <input type="number" class="form-control edit-custom-perc" id="editAkt15Perc" step="0.1" min="0" max="100" value="30">
                                </div>
                                <div class="col-md-6">
                                    <label>Акт 16 (%)</label>
                                    <input type="number" class="form-control edit-custom-perc" id="editAkt16Perc" step="0.1" min="0" max="100" value="10">
                                </div>
                            </div>
                            <div class="text-end mb-3">
                                <strong>Общо: <span id="editTotalPerc">100</span>%</strong>
                            </div>
                        </div>
                        
                        <div id="editPlanPreview" style="display: none;">
                            <h6 class="mb-3"><i class="bi bi-calendar-check"></i> Схема на плащане</h6>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th>Етап</th>
                                        <th>Процент</th>
                                        <th>Сума</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Предварителен договор</td>
                                        <td id="editPrelimPercDisplay">-</td>
                                        <td id="editPrelimAmount">-</td>
                                    </tr>
                                    <tr>
                                        <td>Акт 14</td>
                                        <td id="editAkt14PercDisplay">-</td>
                                        <td id="editAkt14Amount">-</td>
                                    </tr>
                                    <tr>
                                        <td>Акт 15</td>
                                        <td id="editAkt15PercDisplay">-</td>
                                        <td id="editAkt15Amount">-</td>
                                    </tr>
                                    <tr>
                                        <td>Акт 16</td>
                                        <td id="editAkt16PercDisplay">-</td>
                                        <td id="editAkt16Amount">-</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Отказ
                        </button>
                        <button type="button" class="btn btn-primary" id="confirmEditBtn">
                            <i class="bi bi-check-circle"></i> Запази промените
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add Purchase Modal -->
        <div class="modal fade" id="addPurchaseModal" tabindex="-1" aria-labelledby="addPurchaseModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addPurchaseModalLabel">
                            <i class="bi bi-cart-plus me-2"></i>Добави покупка за <span th:text="${client.name}">клиент</span>
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle me-2"></i>
                            Изберете обекти и въведете цена и план за плащане за всеки
                        </div>
                        
                        <div id="availableObjectsLoading" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Зареждане...</span>
                            </div>
                            <p class="text-muted mt-2">Зареждане на налични обекти...</p>
                        </div>
                        
                        <div id="availableObjectsContainer" style="display: none;">
                            <div class="mb-3">
                                <input type="text" class="form-control" id="objectSearchInput" placeholder="Търсене по номер...">
                            </div>
                            
                            <div id="availableObjectsList" style="max-height: 500px; overflow-y: auto;">
                                <!-- Objects will be loaded here -->
                            </div>
                            
                            <div id="noObjectsMessage" class="alert alert-warning mt-3" style="display: none;">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Няма налични обекти за продажба.
                            </div>
                        </div>
                        
                        <div class="mt-3">
                            <strong>Избрани обекти: <span id="selectedCount">0</span></strong>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-circle"></i> Отказ
                        </button>
                        <button type="button" class="btn btn-primary" id="confirmPurchaseBtn" disabled>
                            <i class="bi bi-check-circle"></i> Добави избраните обекти
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Add/Edit Payment Modal -->
        <div class="modal fade" id="paymentModal" tabindex="-1" aria-labelledby="paymentModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="paymentModalLabel">
                            <i class="bi bi-cash-coin me-2"></i>Добави плащане
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="paymentForm">
                            <input type="hidden" id="paymentId" name="id" />
                            <input type="hidden" id="paymentApartmentId" name="apartmentId" />
                            
                            <div class="alert alert-info" id="apartmentInfo">
                                <strong>Обект:</strong> <span id="apartmentInfoText">-</span>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="paymentAmount" class="form-label">Сума (€) *</label>
                                    <input type="number" class="form-control" id="paymentAmount" name="amount" step="0.01" min="0.01" required />
                                    <div class="invalid-feedback"></div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="paymentDate" class="form-label">Дата на плащане *</label>
                                    <input type="date" class="form-control" id="paymentDate" name="paymentDate" required />
                                    <div class="invalid-feedback"></div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="paymentMethod" class="form-label">Метод на плащане</label>
                                    <select class="form-select" id="paymentMethod" name="paymentMethod">
                                        <option value="">Изберете метод</option>
                                        <option value="Банка">Банка</option>
                                        <option value="В брой">В брой</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="paymentStage" class="form-label">Етап на плащане</label>
                                    <select class="form-select" id="paymentStage" name="paymentStage">
                                        <option value="">Изберете етап</option>
                                        <option value="При предварителен договор">При предварителен договор</option>
                                        <option value="Акт 14">Акт 14</option>
                                        <option value="Акт 15">Акт 15</option>
                                        <option value="Акт 16">Акт 16</option>
                                    </select>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="invoiceNumber" class="form-label">Номер на фактура</label>
                                    <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check mt-4">
                                        <input class="form-check-input" type="checkbox" id="isDeposit" name="isDeposit" />
                                        <label class="form-check-label" for="isDeposit">
                                            Капаро
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="paymentNotes" class="form-label">Бележки</label>
                                <textarea class="form-control" id="paymentNotes" name="notes" rows="3"></textarea>
                            </div>

                            <!-- Payment Summary -->
                            <div class="alert alert-info" id="paymentSummary" style="display: none;">
                                <div class="row">
                                    <div class="col-md-4">
                                        <small><strong>Обща цена:</strong> <span id="totalPriceInfo">0.00</span> €</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small><strong>Платено:</strong> <span id="totalPaidInfo">0.00</span> €</small>
                                    </div>
                                    <div class="col-md-4">
                                        <small><strong>Остатък:</strong> <span id="remainingInfo">0.00</span> €</small>
                                    </div>
                                </div>
                            </div>

                            <!-- Payment Plan Progress -->
                            <div id="paymentPlanSection" style="display: none;">
                                <h6 class="mb-3">
                                    <i class="bi bi-calendar-check me-2"></i>План за плащане
                                    <small class="text-muted" id="packageTypeName"></small>
                                </h6>
                                <div class="table-responsive">
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Етап</th>
                                                <th>Очаквано</th>
                                                <th>Платено</th>
                                                <th>Остатък</th>
                                                <th>Статус</th>
                                            </tr>
                                        </thead>
                                        <tbody id="paymentPlanBody">
                                            <!-- Will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="paymentWarning" class="alert alert-warning mt-3" style="display: none;">
                                    <i class="bi bi-exclamation-triangle me-2"></i>
                                    <span id="paymentWarningText"></span>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
                        <button type="button" class="btn btn-primary" id="btnSavePayment">
                            <i class="bi bi-check-circle me-2"></i>Запази
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
        
        <script th:inline="javascript">
        const clientId = [[${client.id}]];
        let selectedObjectsData = {};
        let allObjects = [];
        
        // Payment packages configuration (without discounts)
        const paymentPackages = {
            standard: {
                name: 'Стандартен',
                percentages: { prelim: 30, akt14: 30, akt15: 30, akt16: 10 }
            },
            balanced: {
                name: 'Балансиран',
                percentages: { prelim: 50, akt14: 0, akt15: 0, akt16: 50 }
            },
            optimal: {
                name: 'Оптимален',
                percentages: { prelim: 50, akt14: 30, akt15: 10, akt16: 10 }
            },
            investment: {
                name: 'Инвестиционен',
                percentages: { prelim: 80, akt14: 0, akt15: 0, akt16: 20 }
            },
            profitable: {
                name: 'Печеливш',
                percentages: { prelim: 100, akt14: 0, akt15: 0, akt16: 0 }
            },
            custom: {
                name: 'Индивидуален',
                percentages: { prelim: 30, akt14: 30, akt15: 30, akt16: 10 } // default, will be customized
            }
        };
        
        // Load available objects when modal opens
        $('#addPurchaseModal').on('show.bs.modal', function() {
            loadAvailableObjects();
        });
        
        function loadAvailableObjects() {
            $('#availableObjectsLoading').show();
            $('#availableObjectsContainer').hide();
            selectedObjectsData = {};
            
            $.ajax({
                url: '/apartments/api/available',
                method: 'GET',
                success: function(response) {
                    allObjects = response || [];
                    displayObjects(allObjects);
                    $('#availableObjectsLoading').hide();
                    $('#availableObjectsContainer').show();
                    updateSelectedCount();
                },
                error: function(xhr) {
                    $('#availableObjectsLoading').hide();
                    alert('Грешка при зареждане на обектите');
                }
            });
        }
        
        function displayObjects(objects) {
            const container = $('#availableObjectsList');
            container.empty();
            
            if (objects.length === 0) {
                $('#noObjectsMessage').show();
                return;
            }
            
            $('#noObjectsMessage').hide();
            
            objects.forEach(function(obj) {
                const objCard = $(`
                    <div class="card mb-3" id="card-${obj.id}">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <div class="form-check">
                                    <input class="form-check-input object-checkbox" type="checkbox" value="${obj.id}" id="obj-${obj.id}">
                                    <label class="form-check-label" for="obj-${obj.id}" style="cursor: pointer;">
                                        <strong>${obj.apartmentNumber}</strong>
                                        <br>
                                        <small class="text-muted">
                                            <i class="bi bi-building"></i> ${obj.buildingName || 'Неизвестна сграда'}
                                            | <i class="bi bi-rulers"></i> ${obj.area} кв.м
                                            ${obj.stage ? '| <i class="bi bi-tag"></i> ' + obj.stage : ''}
                                        </small>
                                    </label>
                                </div>
                            </div>
                            
                            <div class="object-details" id="details-${obj.id}" style="display: none;">
                                <hr>
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="bi bi-currency-euro"></i> Обща цена (€) *</label>
                                        <input type="number" class="form-control base-price-input" data-obj-id="${obj.id}" 
                                               step="0.01" min="0.01" required placeholder="Въведете цена">
                                        <small class="text-muted">Основна цена преди отстъпка</small>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label"><i class="bi bi-tag"></i> Пакет за плащане *</label>
                                        <select class="form-select payment-package-select" data-obj-id="${obj.id}" required>
                                            <option value="">Изберете пакет</option>
                                            <option value="standard">Стандартен</option>
                                            <option value="balanced">Балансиран</option>
                                            <option value="optimal">Оптимален</option>
                                            <option value="investment">Инвестиционен</option>
                                            <option value="profitable">Печеливш</option>
                                            <option value="custom">Индивидуален</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div class="price-summary mb-3" id="price-summary-${obj.id}" style="display: none;">
                                    <div class="alert alert-info text-center">
                                        <h5 class="mb-0">
                                            <strong>Обща цена: </strong>
                                            <span class="text-success" id="final-price-${obj.id}">0.00 €</span>
                                        </h5>
                                    </div>
                                </div>
                                
                                <div class="payment-plan-section" id="plan-${obj.id}" style="display: none;">
                                    <h6 class="mb-3"><i class="bi bi-calendar-check"></i> Схема на плащане</h6>
                                    
                                    <div class="custom-percentages" id="custom-perc-${obj.id}" style="display: none;">
                                        <div class="alert alert-warning">
                                            <i class="bi bi-exclamation-triangle"></i> 
                                            Общият процент трябва да е 100%
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label>Предварителен договор (%)</label>
                                                <input type="number" class="form-control custom-perc" data-stage="prelim" data-obj-id="${obj.id}" 
                                                       step="0.1" min="0" max="100" value="30">
                                            </div>
                                            <div class="col-md-6">
                                                <label>Акт 14 (%)</label>
                                                <input type="number" class="form-control custom-perc" data-stage="akt14" data-obj-id="${obj.id}" 
                                                       step="0.1" min="0" max="100" value="30">
                                            </div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-6">
                                                <label>Акт 15 (%)</label>
                                                <input type="number" class="form-control custom-perc" data-stage="akt15" data-obj-id="${obj.id}" 
                                                       step="0.1" min="0" max="100" value="30">
                                            </div>
                                            <div class="col-md-6">
                                                <label>Акт 16 (%)</label>
                                                <input type="number" class="form-control custom-perc" data-stage="akt16" data-obj-id="${obj.id}" 
                                                       step="0.1" min="0" max="100" value="10">
                                            </div>
                                        </div>
                                        <div class="text-end mb-3">
                                            <strong>Общо: <span id="total-perc-${obj.id}">100</span>%</strong>
                                        </div>
                                    </div>
                                    
                                    <table class="table table-sm table-bordered">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Етап</th>
                                                <th>Процент</th>
                                                <th>Сума</th>
                                            </tr>
                                        </thead>
                                        <tbody id="plan-preview-${obj.id}">
                                            <tr>
                                                <td>Предварителен договор</td>
                                                <td id="prelim-perc-${obj.id}">-</td>
                                                <td id="prelim-amount-${obj.id}">-</td>
                                            </tr>
                                            <tr>
                                                <td>Акт 14</td>
                                                <td id="akt14-perc-${obj.id}">-</td>
                                                <td id="akt14-amount-${obj.id}">-</td>
                                            </tr>
                                            <tr>
                                                <td>Акт 15</td>
                                                <td id="akt15-perc-${obj.id}">-</td>
                                                <td id="akt15-amount-${obj.id}">-</td>
                                            </tr>
                                            <tr>
                                                <td>Акт 16</td>
                                                <td id="akt16-perc-${obj.id}">-</td>
                                                <td id="akt16-amount-${obj.id}">-</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `);
                
                container.append(objCard);
            });
            
            // Event handlers
            $('.object-checkbox').on('change', function() {
                const objId = parseInt($(this).val());
                const isChecked = $(this).is(':checked');
                
                if (isChecked) {
                    $(`#details-${objId}`).slideDown();
                    $(`#card-${objId}`).addClass('border-primary');
                    const obj = allObjects.find(o => o.id === objId);
                    selectedObjectsData[objId] = {
                        id: objId,
                        apartmentNumber: obj.apartmentNumber,
                        basePrice: null,
                        package: null,
                        finalPrice: null,
                        percentages: null
                    };
                } else {
                    $(`#details-${objId}`).slideUp();
                    $(`#card-${objId}`).removeClass('border-primary');
                    delete selectedObjectsData[objId];
                }
                updateSelectedCount();
            });
            
            $('.base-price-input').on('input', function() {
                const objId = $(this).data('obj-id');
                if (selectedObjectsData[objId]) {
                    selectedObjectsData[objId].basePrice = parseFloat($(this).val()) || null;
                    recalculatePricing(objId);
                }
            });
            
            $('.payment-package-select').on('change', function() {
                const objId = $(this).data('obj-id');
                const packageType = $(this).val();
                
                if (selectedObjectsData[objId]) {
                    selectedObjectsData[objId].package = packageType;
                    
                    // Show/hide custom percentages section
                    if (packageType === 'custom') {
                        $(`#custom-perc-${objId}`).slideDown();
                    } else {
                        $(`#custom-perc-${objId}`).slideUp();
                    }
                    
                    if (packageType) {
                        $(`#plan-${objId}`).slideDown();
                    } else {
                        $(`#plan-${objId}`).slideUp();
                    }
                    
                    recalculatePricing(objId);
                }
            });
            
            $('.custom-perc').on('input', function() {
                const objId = $(this).data('obj-id');
                recalculatePricing(objId);
            });
        }
        
        function recalculatePricing(objId) {
            const data = selectedObjectsData[objId];
            if (!data || !data.basePrice || !data.package) {
                $(`#price-summary-${objId}`).hide();
                return;
            }
            
            const totalPrice = data.basePrice;
            const packageType = data.package;
            let percentages = {};
            
            if (packageType === 'custom') {
                percentages = {
                    prelim: parseFloat($(`.custom-perc[data-stage="prelim"][data-obj-id="${objId}"]`).val()) || 0,
                    akt14: parseFloat($(`.custom-perc[data-stage="akt14"][data-obj-id="${objId}"]`).val()) || 0,
                    akt15: parseFloat($(`.custom-perc[data-stage="akt15"][data-obj-id="${objId}"]`).val()) || 0,
                    akt16: parseFloat($(`.custom-perc[data-stage="akt16"][data-obj-id="${objId}"]`).val()) || 0
                };
                
                const totalPerc = percentages.prelim + percentages.akt14 + percentages.akt15 + percentages.akt16;
                $(`#total-perc-${objId}`).text(totalPerc.toFixed(1));
                
                if (Math.abs(totalPerc - 100) > 0.1) {
                    $(`#total-perc-${objId}`).addClass('text-danger');
                } else {
                    $(`#total-perc-${objId}`).removeClass('text-danger');
                }
            } else {
                const pkg = paymentPackages[packageType];
                percentages = pkg.percentages;
            }
            
            // Update data
            data.finalPrice = totalPrice;
            data.percentages = percentages;
            
            // Calculate amounts with proper rounding to 2 decimal places
            const prelimAmount = Math.round(totalPrice * percentages.prelim) / 100;
            const akt14Amount = Math.round(totalPrice * percentages.akt14) / 100;
            const akt15Amount = Math.round(totalPrice * percentages.akt15) / 100;
            
            // Calculate last amount to ensure total equals totalPrice exactly
            const akt16Amount = totalPrice - prelimAmount - akt14Amount - akt15Amount;
            
            // Update UI
            $(`#final-price-${objId}`).text(formatCurrency(totalPrice) + ' €');
            
            // Update payment plan preview
            $(`#prelim-perc-${objId}`).text(percentages.prelim + '%');
            $(`#prelim-amount-${objId}`).text(formatCurrency(prelimAmount) + ' €');
            
            $(`#akt14-perc-${objId}`).text(percentages.akt14 + '%');
            $(`#akt14-amount-${objId}`).text(formatCurrency(akt14Amount) + ' €');
            
            $(`#akt15-perc-${objId}`).text(percentages.akt15 + '%');
            $(`#akt15-amount-${objId}`).text(formatCurrency(akt15Amount) + ' €');
            
            $(`#akt16-perc-${objId}`).text(percentages.akt16 + '%');
            $(`#akt16-amount-${objId}`).text(formatCurrency(akt16Amount) + ' €');
            
            $(`#price-summary-${objId}`).slideDown();
        }
        
        function updateSelectedCount() {
            const count = Object.keys(selectedObjectsData).length;
            $('#selectedCount').text(count);
            $('#confirmPurchaseBtn').prop('disabled', count === 0);
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('bg-BG', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
        
        // Search functionality
        $('#objectSearchInput').on('input', function() {
            const searchTerm = $(this).val().toLowerCase();
            $('.card').each(function() {
                const objId = $(this).find('.object-checkbox').val();
                const obj = allObjects.find(o => o.id == objId);
                if (obj && (obj.apartmentNumber.toLowerCase().includes(searchTerm) ||
                            (obj.buildingName && obj.buildingName.toLowerCase().includes(searchTerm)))) {
                    $(this).show();
                } else {
                    $(this).hide();
                }
            });
        });
        
        // Confirm purchase
        $('#confirmPurchaseBtn').on('click', function() {
            const selectedIds = Object.keys(selectedObjectsData);
            if (selectedIds.length === 0) return;
            
            // Validate all selected objects
            let hasError = false;
            const purchases = [];
            
            selectedIds.forEach(objId => {
                const data = selectedObjectsData[objId];
                
                if (!data.basePrice || data.basePrice <= 0) {
                    alert(`Моля въведете цена за ${data.apartmentNumber}`);
                    hasError = true;
                    return;
                }
                
                if (!data.package) {
                    alert(`Моля изберете пакет за плащане за ${data.apartmentNumber}`);
                    hasError = true;
                    return;
                }
                
                // Validate custom package percentages
                if (data.package === 'custom' && data.percentages) {
                    const totalPerc = data.percentages.prelim + data.percentages.akt14 + 
                                    data.percentages.akt15 + data.percentages.akt16;
                    console.log(`Custom package validation for ${objId}: ${totalPerc}%`);
                    if (Math.abs(totalPerc - 100) > 0.1) {
                        alert(`Общият процент за ${data.apartmentNumber} трябва да е 100%! (Сега е ${totalPerc.toFixed(1)}%)`);
                        hasError = true;
                        return;
                    }
                }
                
                const finalPrice = data.finalPrice;
                const percentages = data.percentages;
                
                // Calculate amounts with same logic as UI - ensuring sum equals finalPrice
                const prelimAmount = Math.round(finalPrice * percentages.prelim) / 100;
                const akt14Amount = Math.round(finalPrice * percentages.akt14) / 100;
                const akt15Amount = Math.round(finalPrice * percentages.akt15) / 100;
                const akt16Amount = finalPrice - prelimAmount - akt14Amount - akt15Amount;
                
                const purchase = {
                    apartmentId: parseInt(objId),
                    finalPrice: finalPrice,
                    packageType: data.package,
                    paymentPlan: {
                        preliminaryContractAmount: prelimAmount,
                        akt14Amount: akt14Amount,
                        akt15Amount: akt15Amount,
                        akt16Amount: akt16Amount
                    }
                };
                
                console.log('Purchase object created:', purchase);
                purchases.push(purchase);
            });
            
            if (hasError) {
                console.log('Validation failed, stopping');
                return;
            }
            
            console.log('All purchases prepared:', purchases);
            console.log('Sending to API...');
            
            $(this).prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Обработка...');
            
            const payload = { purchases: purchases };
            console.log('Payload:', JSON.stringify(payload, null, 2));
            
            $.ajax({
                url: `/clients/api/${clientId}/add-purchases`,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    console.log('AJAX Success:', response);
                    if (response.success) {
                        alert('Успешно добавени ' + response.count + ' обекта!');
                        $('#addPurchaseModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Грешка: ' + (response.message || 'Неуспешно добавяне'));
                        $('#confirmPurchaseBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Добави избраните обекти');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', status, error);
                    console.error('XHR:', xhr);
                    console.error('Response Text:', xhr.responseText);
                    let errorMsg = 'Грешка при добавяне на покупките';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        errorMsg += ': ' + xhr.responseText;
                    }
                    alert(errorMsg);
                    $('#confirmPurchaseBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Добави избраните обекти');
                }
            });
        });
        
        // ===== EDIT PURCHASE =====
        $(document).on('click', '.edit-purchase-btn', function() {
            const aptId = $(this).data('apt-id');
            const aptNumber = $(this).data('apt-number');
            const totalPrice = parseFloat($(this).data('total-price'));
            const prelim = parseFloat($(this).data('prelim'));
            const akt14 = parseFloat($(this).data('akt14'));
            const akt15 = parseFloat($(this).data('akt15'));
            const akt16 = parseFloat($(this).data('akt16'));
            
            // Set values
            $('#editAptId').val(aptId);
            $('#editAptNumber').text(aptNumber);
            $('#editTotalPrice').val(totalPrice.toFixed(2));
            
            // Calculate percentages from amounts
            if (totalPrice > 0) {
                const prelimPerc = (prelim / totalPrice) * 100;
                const akt14Perc = (akt14 / totalPrice) * 100;
                const akt15Perc = (akt15 / totalPrice) * 100;
                const akt16Perc = (akt16 / totalPrice) * 100;
                
                // Determine package type
                let detectedPackage = 'custom';
                Object.keys(paymentPackages).forEach(key => {
                    const pkg = paymentPackages[key];
                    if (Math.abs(pkg.percentages.prelim - prelimPerc) < 0.5 &&
                        Math.abs(pkg.percentages.akt14 - akt14Perc) < 0.5 &&
                        Math.abs(pkg.percentages.akt15 - akt15Perc) < 0.5 &&
                        Math.abs(pkg.percentages.akt16 - akt16Perc) < 0.5) {
                        detectedPackage = key;
                    }
                });
                
                $('#editPaymentPackage').val(detectedPackage);
                
                if (detectedPackage === 'custom') {
                    $('#editPrelimPerc').val(prelimPerc.toFixed(1));
                    $('#editAkt14Perc').val(akt14Perc.toFixed(1));
                    $('#editAkt15Perc').val(akt15Perc.toFixed(1));
                    $('#editAkt16Perc').val(akt16Perc.toFixed(1));
                    $('#editCustomPercentages').show();
                } else {
                    $('#editCustomPercentages').hide();
                }
                
                $('#editPlanPreview').show();
                recalculateEditPricing();
            }
            
            $('#editPurchaseModal').modal('show');
        });
        
        $('#editPaymentPackage').on('change', function() {
            const packageType = $(this).val();
            if (packageType === 'custom') {
                $('#editCustomPercentages').slideDown();
            } else {
                $('#editCustomPercentages').slideUp();
            }
            
            if (packageType) {
                $('#editPlanPreview').slideDown();
            } else {
                $('#editPlanPreview').slideUp();
            }
            
            recalculateEditPricing();
        });
        
        $('#editTotalPrice, .edit-custom-perc').on('input', function() {
            recalculateEditPricing();
        });
        
        function recalculateEditPricing() {
            const totalPrice = parseFloat($('#editTotalPrice').val());
            const packageType = $('#editPaymentPackage').val();
            
            if (!totalPrice || totalPrice <= 0 || !packageType) {
                $('#editPlanPreview').hide();
                return;
            }
            
            let percentages = {};
            
            if (packageType === 'custom') {
                percentages = {
                    prelim: parseFloat($('#editPrelimPerc').val()) || 0,
                    akt14: parseFloat($('#editAkt14Perc').val()) || 0,
                    akt15: parseFloat($('#editAkt15Perc').val()) || 0,
                    akt16: parseFloat($('#editAkt16Perc').val()) || 0
                };
                
                const totalPerc = percentages.prelim + percentages.akt14 + percentages.akt15 + percentages.akt16;
                $('#editTotalPerc').text(totalPerc.toFixed(1));
                
                if (Math.abs(totalPerc - 100) > 0.1) {
                    $('#editTotalPerc').addClass('text-danger');
                } else {
                    $('#editTotalPerc').removeClass('text-danger');
                }
            } else {
                const pkg = paymentPackages[packageType];
                percentages = pkg.percentages;
            }
            
            // Calculate amounts with proper rounding to 2 decimal places
            const prelimAmount = Math.round(totalPrice * percentages.prelim) / 100;
            const akt14Amount = Math.round(totalPrice * percentages.akt14) / 100;
            const akt15Amount = Math.round(totalPrice * percentages.akt15) / 100;
            const akt16Amount = totalPrice - prelimAmount - akt14Amount - akt15Amount;
            
            // Update UI
            $('#editPrelimPercDisplay').text(percentages.prelim + '%');
            $('#editPrelimAmount').text(formatCurrency(prelimAmount) + ' €');
            
            $('#editAkt14PercDisplay').text(percentages.akt14 + '%');
            $('#editAkt14Amount').text(formatCurrency(akt14Amount) + ' €');
            
            $('#editAkt15PercDisplay').text(percentages.akt15 + '%');
            $('#editAkt15Amount').text(formatCurrency(akt15Amount) + ' €');
            
            $('#editAkt16PercDisplay').text(percentages.akt16 + '%');
            $('#editAkt16Amount').text(formatCurrency(akt16Amount) + ' €');
            
            $('#editPlanPreview').show();
        }
        
        $('#confirmEditBtn').on('click', function() {
            const aptId = $('#editAptId').val();
            const totalPrice = parseFloat($('#editTotalPrice').val());
            const packageType = $('#editPaymentPackage').val();
            
            if (!totalPrice || totalPrice <= 0) {
                alert('Моля въведете валидна цена');
                return;
            }
            
            if (!packageType) {
                alert('Моля изберете пакет за плащане');
                return;
            }
            
            let percentages = {};
            
            if (packageType === 'custom') {
                percentages = {
                    prelim: parseFloat($('#editPrelimPerc').val()) || 0,
                    akt14: parseFloat($('#editAkt14Perc').val()) || 0,
                    akt15: parseFloat($('#editAkt15Perc').val()) || 0,
                    akt16: parseFloat($('#editAkt16Perc').val()) || 0
                };
                
                const totalPerc = percentages.prelim + percentages.akt14 + percentages.akt15 + percentages.akt16;
                if (Math.abs(totalPerc - 100) > 0.1) {
                    alert(`Общият процент трябва да е 100%! (Сега е ${totalPerc.toFixed(1)}%)`);
                    return;
                }
            } else {
                const pkg = paymentPackages[packageType];
                percentages = pkg.percentages;
            }
            
            // Calculate amounts with same logic as UI
            const prelimAmount = Math.round(totalPrice * percentages.prelim) / 100;
            const akt14Amount = Math.round(totalPrice * percentages.akt14) / 100;
            const akt15Amount = Math.round(totalPrice * percentages.akt15) / 100;
            const akt16Amount = totalPrice - prelimAmount - akt14Amount - akt15Amount;
            
            const payload = {
                totalPrice: totalPrice,
                packageType: packageType,
                paymentPlan: {
                    preliminaryContractAmount: prelimAmount,
                    akt14Amount: akt14Amount,
                    akt15Amount: akt15Amount,
                    akt16Amount: akt16Amount
                }
            };
            
            $('#confirmEditBtn').prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Запазване...');
            
            $.ajax({
                url: `/clients/api/${clientId}/purchases/${aptId}`,
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify(payload),
                success: function(response) {
                    if (response.success) {
                        alert('Успешно редактирана покупка!');
                        $('#editPurchaseModal').modal('hide');
                        location.reload();
                    } else {
                        alert('Грешка: ' + (response.message || 'Неуспешно редактиране'));
                        $('#confirmEditBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Запази промените');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Грешка при редактиране на покупката';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                    $('#confirmEditBtn').prop('disabled', false).html('<i class="bi bi-check-circle"></i> Запази промените');
                }
            });
        });
        
        // ===== DELETE PURCHASE =====
        $(document).on('click', '.delete-purchase-btn', function() {
            const aptId = $(this).data('apt-id');
            const aptNumber = $(this).data('apt-number');
            
            if (!confirm(`Сигурни ли сте, че искате да изтриете покупката на ${aptNumber}?\n\nВНИМАНИЕ: Това ще премахне връзката между клиента и обекта. Всички плащания ще бъдат изтрити!`)) {
                return;
            }
            
            $.ajax({
                url: `/clients/api/${clientId}/purchases/${aptId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        alert('Успешно изтрита покупка!');
                        location.reload();
                    } else {
                        alert('Грешка: ' + (response.message || 'Неуспешно изтриване'));
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Грешка при изтриване на покупката';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                }
            });
        });
        
        // ===== PAYMENT HANDLING =====
        // Handler for "Add Payment" button
        $(document).on('click', '.add-payment-btn', function() {
            const aptId = $(this).data('apt-id');
            const aptNumber = $(this).data('apt-number');
            const buildingName = $(this).data('building-name');
            
            openAddPaymentModal(aptId, buildingName, aptNumber);
        });
        
        /**
         * Open add payment modal for specific apartment
         */
        function openAddPaymentModal(apartmentId, buildingName, apartmentNumber) {
            // Reset form
            $('#paymentForm')[0].reset();
            $('#paymentId').val('');
            $('#paymentApartmentId').val(apartmentId);
            $('#apartmentInfoText').text(buildingName + ' - ' + apartmentNumber);
            
            // Clear previous hints
            $('#paymentHint').remove();
            $('#depositWarning').remove();
            
            // Set modal title
            $('#paymentModalLabel').html('<i class="bi bi-cash-coin me-2"></i>Добави плащане');
            
            // Load payment summary and plan
            loadPaymentSummary(apartmentId);
            
            // Check if deposit already exists
            checkAndDisableDeposit(apartmentId);
            
            // Set default date to today
            $('#paymentDate').val(new Date().toISOString().split('T')[0]);
            
            $('#paymentModal').modal('show');
        }
        
        /**
         * Load payment summary for apartment
         */
        function loadPaymentSummary(apartmentId) {
            $.ajax({
                url: `/payments/api/apartment/${apartmentId}/total`,
                method: 'GET',
                success: function(data) {
                    $('#totalPriceInfo').text(parseFloat(data.totalPrice || 0).toFixed(2));
                    $('#totalPaidInfo').text(parseFloat(data.totalPaid || 0).toFixed(2));
                    $('#remainingInfo').text(parseFloat(data.remainingPayment || 0).toFixed(2));
                    $('#paymentSummary').show();
                },
                error: function() {
                    $('#paymentSummary').hide();
                }
            });
            
            // Load payment plan details
            loadPaymentPlan(apartmentId);
        }
        
        /**
         * Load payment plan details with progress by stage
         */
        function loadPaymentPlan(apartmentId) {
            $.ajax({
                url: `/payments/api/apartment/${apartmentId}/payment-plan`,
                method: 'GET',
                success: function(data) {
                    if (!data.hasPaymentPlan) {
                        $('#paymentPlanSection').hide();
                        return;
                    }
                    
                    const stages = [
                        { key: 'prelim', name: 'При предварителен договор' },
                        { key: 'akt14', name: 'Акт 14' },
                        { key: 'akt15', name: 'Акт 15' },
                        { key: 'akt16', name: 'Акт 16' }
                    ];
                    
                    const tbody = $('#paymentPlanBody');
                    tbody.empty();
                    
                    let cumulativeOverpayment = 0;
                    
                    stages.forEach((stage, index) => {
                        const expected = parseFloat(data.expectedAmounts[stage.key] || 0);
                        let paid = parseFloat(data.paidByStage[stage.key] || 0);
                        
                        if (cumulativeOverpayment > 0) {
                            const toApply = Math.min(cumulativeOverpayment, Math.max(0, expected - paid));
                            paid += toApply;
                            cumulativeOverpayment -= toApply;
                        }
                        
                        const remaining = Math.max(0, expected - paid);
                        const overpayment = Math.max(0, paid - expected);
                        
                        if (overpayment > 0) {
                            cumulativeOverpayment += overpayment;
                        }
                        
                        let statusBadge = '';
                        let rowClass = '';
                        
                        if (paid >= expected && expected > 0) {
                            statusBadge = '<span class="badge bg-success">Платено</span>';
                            rowClass = 'table-success';
                        } else if (paid > 0 && paid < expected) {
                            statusBadge = '<span class="badge bg-warning">Частично</span>';
                            rowClass = 'table-warning';
                        } else if (expected > 0) {
                            statusBadge = '<span class="badge bg-secondary">Неплатено</span>';
                        } else {
                            statusBadge = '<span class="badge bg-light text-dark">Не се прилага</span>';
                            rowClass = 'table-light';
                        }
                        
                        const row = `
                            <tr class="${rowClass}">
                                <td><strong>${stage.name}</strong></td>
                                <td>${formatCurrency(expected)} €</td>
                                <td>${formatCurrency(paid)} €${overpayment > 0 ? ' <span class="badge bg-info">+' + formatCurrency(overpayment) + '</span>' : ''}</td>
                                <td class="${remaining > 0 ? 'text-danger fw-bold' : ''}">${formatCurrency(remaining)} €</td>
                                <td>${statusBadge}</td>
                            </tr>
                        `;
                        
                        tbody.append(row);
                    });
                    
                    const otherPayments = parseFloat(data.paidByStage.other || 0);
                    if (otherPayments > 0 || cumulativeOverpayment > 0) {
                        const totalUnallocated = otherPayments + cumulativeOverpayment;
                        $('#paymentWarningText').html(
                            `<strong>Внимание:</strong> Има ${formatCurrency(totalUnallocated)} € нерапределени плащания. ` +
                            `Моля свържете плащанията с конкретен етап.`
                        );
                        $('#paymentWarning').show();
                    } else {
                        $('#paymentWarning').hide();
                    }
                    
                    $('#paymentPlanSection').show();
                },
                error: function() {
                    $('#paymentPlanSection').hide();
                }
            });
        }
        
        /**
         * Check if deposit exists and disable checkbox if it does
         */
        function checkAndDisableDeposit(apartmentId) {
            $.ajax({
                url: `/payments/api/apartment/${apartmentId}/hasDeposit`,
                method: 'GET',
                success: function(data) {
                    const depositCheckbox = $('#isDeposit');
                    if (data.hasDeposit) {
                        depositCheckbox.prop('disabled', true);
                        depositCheckbox.prop('checked', false);
                        
                        if (!$('#depositWarning').length) {
                            depositCheckbox.closest('.form-check').after(
                                '<small id="depositWarning" class="text-warning d-block mt-1">' +
                                '<i class="bi bi-exclamation-triangle me-1"></i>' +
                                'Капаро вече е платено за този обект' +
                                '</small>'
                            );
                        }
                    } else {
                        depositCheckbox.prop('disabled', false);
                        $('#depositWarning').remove();
                    }
                },
                error: function() {
                    $('#isDeposit').prop('disabled', false);
                    $('#depositWarning').remove();
                }
            });
        }
        
        /**
         * Format currency with proper decimal places
         */
        function formatCurrency(value) {
            return new Intl.NumberFormat('bg-BG', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(value);
        }
        
        /**
         * Validate payment amount and suggest stage
         */
        function validatePaymentAmount() {
            const amount = parseFloat($('#paymentAmount').val()) || 0;
            const remaining = parseFloat($('#remainingInfo').text().replace(' €', '').replace(',', '')) || 0;
            const paymentId = $('#paymentId').val();
            
            if (amount > remaining && !paymentId) {
                $('#paymentAmount').addClass('is-invalid');
                $('#paymentAmount').next('.invalid-feedback').text('Сумата надвишава остатъка за плащане');
            } else {
                $('#paymentAmount').removeClass('is-invalid');
            }
            
            if (amount > 0 && !paymentId) {
                suggestPaymentStage(amount);
            }
        }
        
        /**
         * Suggest payment stage based on payment plan progress
         */
        function suggestPaymentStage(amount) {
            const apartmentId = $('#paymentApartmentId').val();
            
            if (!apartmentId) return;
            
            $.ajax({
                url: `/payments/api/apartment/${apartmentId}/payment-plan`,
                method: 'GET',
                success: function(data) {
                    if (!data.hasPaymentPlan) return;
                    
                    const stages = [
                        { key: 'prelim', name: 'При предварителен договор', value: 'При предварителен договор' },
                        { key: 'akt14', name: 'Акт 14', value: 'Акт 14' },
                        { key: 'akt15', name: 'Акт 15', value: 'Акт 15' },
                        { key: 'akt16', name: 'Акт 16', value: 'Акт 16' }
                    ];
                    
                    let suggestedStage = null;
                    let suggestedAmount = 0;
                    
                    for (const stage of stages) {
                        const expected = parseFloat(data.expectedAmounts[stage.key] || 0);
                        const paid = parseFloat(data.paidByStage[stage.key] || 0);
                        const remaining = expected - paid;
                        
                        if (remaining > 0.01) {
                            suggestedStage = stage;
                            suggestedAmount = remaining;
                            break;
                        }
                    }
                    
                    if (suggestedStage) {
                        $('#paymentStage').val(suggestedStage.value);
                        
                        const diff = amount - suggestedAmount;
                        let hintMessage = '';
                        
                        if (Math.abs(diff) < 0.01) {
                            hintMessage = `<i class="bi bi-check-circle text-success"></i> Плащането покрива точно етап "${suggestedStage.name}"`;
                        } else if (diff < 0) {
                            hintMessage = `<i class="bi bi-exclamation-triangle text-warning"></i> Недостига ${formatCurrency(Math.abs(diff))} € за покриване на "${suggestedStage.name}" (очаквано: ${formatCurrency(suggestedAmount)} €)`;
                        } else {
                            hintMessage = `<i class="bi bi-info-circle text-info"></i> Надвишение от ${formatCurrency(diff)} € ще се отчете за следващия етап`;
                        }
                        
                        if (!$('#paymentHint').length) {
                            $('#paymentAmount').after('<small id="paymentHint" class="form-text"></small>');
                        }
                        $('#paymentHint').html(hintMessage);
                    }
                }
            });
        }
        
        // Payment amount validation
        $('#paymentAmount').on('input', function() {
            validatePaymentAmount();
        });
        
        // Clear hint when stage is manually changed
        $('#paymentStage').on('change', function() {
            $('#paymentHint').remove();
        });
        
        // ===== PAYMENT CRUD OPERATIONS =====
        
        // Edit Payment button handler
        $(document).on('click', '.edit-payment-btn', function() {
            const paymentId = $(this).data('payment-id');
            const aptId = $(this).data('apt-id');
            const aptNumber = $(this).data('apt-number');
            const buildingName = $(this).data('building-name');
            const amount = $(this).data('amount');
            const date = $(this).data('date');
            const method = $(this).data('method');
            const stage = $(this).data('stage');
            const invoice = $(this).data('invoice');
            const isDeposit = $(this).data('is-deposit');
            const notes = $(this).data('notes');
            
            openEditPaymentModal(paymentId, aptId, buildingName, aptNumber, amount, date, method, stage, invoice, isDeposit, notes);
        });
        
        /**
         * Open edit payment modal with prefilled data
         */
        function openEditPaymentModal(paymentId, apartmentId, buildingName, apartmentNumber, amount, date, method, stage, invoice, isDeposit, notes) {
            // Reset and fill form
            $('#paymentForm')[0].reset();
            $('#paymentId').val(paymentId);
            $('#paymentApartmentId').val(apartmentId);
            $('#apartmentInfoText').text(buildingName + ' - ' + apartmentNumber);
            $('#paymentAmount').val(amount);
            $('#paymentDate').val(date);
            $('#paymentMethod').val(method || '');
            $('#paymentStage').val(stage || '');
            $('#invoiceNumber').val(invoice || '');
            $('#isDeposit').prop('checked', isDeposit === true || isDeposit === 'true');
            $('#paymentNotes').val(notes || '');
            
            // Clear previous hints
            $('#paymentHint').remove();
            $('#depositWarning').remove();
            
            // Set modal title
            $('#paymentModalLabel').html('<i class="bi bi-pencil me-2"></i>Редактирай плащане');
            
            // Load payment summary and plan
            loadPaymentSummary(apartmentId);
            
            // For edit mode, don't disable deposit checkbox (user can uncheck it)
            $('#isDeposit').prop('disabled', false);
            
            $('#paymentModal').modal('show');
        }
        
        // Delete Payment button handler
        $(document).on('click', '.delete-payment-btn', function() {
            const paymentId = $(this).data('payment-id');
            const amount = $(this).data('amount');
            const date = $(this).data('date');
            
            if (confirm(`Сигурни ли сте, че искате да изтриете плащането?\n\nСума: ${amount} €\nДата: ${date}`)) {
                deletePayment(paymentId);
            }
        });
        
        /**
         * Delete payment by ID
         */
        function deletePayment(paymentId) {
            $.ajax({
                url: `/payments/api/delete/${paymentId}`,
                method: 'DELETE',
                success: function(response) {
                    if (response.success) {
                        alert('Плащането е изтрито успешно!');
                        location.reload();
                    } else {
                        alert('Грешка: ' + (response.message || 'Неуспешно изтриване'));
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Грешка при изтриване на плащането';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    alert(errorMsg);
                }
            });
        }
        
        // ===== DELAYED PAYMENT VISUAL INDICATOR =====
        
        /**
         * Check all apartments for delayed payments and apply visual indicator
         * Based on CURRENT STAGE and CUMULATIVE PAYMENTS up to that stage
         * ONLY checks stages that exist in the payment plan (expectedAmount > 0)
         */
        function checkDelayedPayments() {
            $('.apartment-card').each(function() {
                const card = $(this);
                const aptId = card.data('apt-id');
                const hasPlan = card.data('has-plan');
                const currentStage = card.data('stage'); // Get current stage from data attribute
                
                // Only check apartments with payment plan
                if (!hasPlan) {
                    return;
                }
                
                // Check payment plan for this apartment
                $.ajax({
                    url: `/payments/api/apartment/${aptId}/payment-plan`,
                    method: 'GET',
                    success: function(data) {
                        if (!data.hasPaymentPlan) {
                            return;
                        }
                        
                        // Define stage order
                        const stageOrder = ['prelim', 'akt14', 'akt15', 'akt16'];
                        const stageMappingToKey = {
                            'Предварителен договор': 'prelim',
                            'При предварителен договор': 'prelim',
                            'Акт 14': 'akt14',
                            'Акт 15': 'akt15',
                            'Акт 16': 'akt16'
                        };
                        
                        const currentStageKey = stageMappingToKey[currentStage];
                        if (!currentStageKey) {
                            return; // Unknown stage
                        }
                        
                        // Find the index of current stage
                        const currentStageIndex = stageOrder.indexOf(currentStageKey);
                        if (currentStageIndex === -1) {
                            return;
                        }
                        
                        // Get all stages up to and including current stage
                        const stagesToCheck = stageOrder.slice(0, currentStageIndex + 1);
                        
                        // FILTER: Only include stages that have expectedAmount > 0 (exist in payment plan)
                        const activeStages = stagesToCheck.filter(stageKey => {
                            const expected = parseFloat(data.expectedAmounts[stageKey] || 0);
                            return expected > 0.01; // Only stages with actual expected payment
                        });
                        
                        if (activeStages.length === 0) {
                            return; // No active stages to check
                        }
                        
                        // Calculate expected cumulative amount ONLY for active stages
                        let expectedCumulative = 0;
                        activeStages.forEach(stageKey => {
                            expectedCumulative += parseFloat(data.expectedAmounts[stageKey] || 0);
                        });
                        
                        // Calculate total paid (all payments regardless of stage assignment)
                        let totalPaid = 0;
                        for (const stageKey in data.paidByStage) {
                            totalPaid += parseFloat(data.paidByStage[stageKey] || 0);
                        }
                        
                        // Check if there's a shortfall (delay)
                        const shortfall = expectedCumulative - totalPaid;
                        const hasDelay = shortfall > 0.01; // Allow small rounding differences
                        
                        // Apply visual indicator if there's a delay
                        if (hasDelay) {
                            card.css({
                                'border': '3px solid #ff8c00',
                                'border-left': '6px solid #ff6600',
                                'box-shadow': '0 0 10px rgba(255, 140, 0, 0.3)'
                            });
                            
                            // Add badge indicator at the top of the card (only once)
                            if (card.find('.delay-indicator').length === 0) {
                                const shortfallFormatted = formatCurrency(shortfall);
                                card.find('.card-body > .row').first().before(`
                                    <div class="alert alert-warning delay-indicator mb-3 py-2 px-3" style="font-size: 0.9em;">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <strong>Забавено плащане!</strong> Недостиг: ${shortfallFormatted} € за текущ етап
                                    </div>
                                `);
                            }
                        }
                    },
                    error: function() {
                        // Silently fail - no visual indicator
                    }
                });
            });
        }
        
        // Check for delayed payments when page loads
        $(document).ready(function() {
            checkDelayedPayments();
            
            // Animate collapse icon on payment history toggle
            $('[data-bs-toggle="collapse"]').on('click', function() {
                const icon = $(this).find('.collapse-icon');
                const isCollapsed = $(this).hasClass('collapsed');
                
                if (isCollapsed) {
                    icon.css('transform', 'rotate(180deg)');
                } else {
                    icon.css('transform', 'rotate(0deg)');
                }
            });
        });
        
        // Save payment
        $('#btnSavePayment').on('click', function() {
            const form = $('#paymentForm')[0];
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                id: $('#paymentId').val() || null,
                amount: parseFloat($('#paymentAmount').val()),
                paymentDate: $('#paymentDate').val(),
                paymentMethod: $('#paymentMethod').val() || null,
                paymentStage: $('#paymentStage').val() || null,
                invoiceNumber: $('#invoiceNumber').val() || null,
                isDeposit: $('#isDeposit').is(':checked'),
                notes: $('#paymentNotes').val() || null,
                apartment: {
                    id: parseInt($('#paymentApartmentId').val())
                }
            };
            
            const isEdit = formData.id !== null && formData.id !== '';
            const url = isEdit ? `/payments/api/update/${formData.id}` : '/payments/api/add';
            const method = isEdit ? 'PUT' : 'POST';
            
            $.ajax({
                url: url,
                method: method,
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    if (response.success) {
                        alert('Плащането е запазено успешно!');
                        $('#paymentModal').modal('hide');
                        $('#paymentHint').remove();
                        location.reload();
                    } else {
                        alert('Грешка: ' + (response.message || 'Неуспешно запазване'));
                    }
                },
                error: function(xhr) {
                    let errorMessage = 'Грешка при запазване';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMessage = xhr.responseJSON.message;
                    }
                    alert(errorMessage);
                }
            });
        });
        </script>
        
        <!-- Sidebar Script -->
        <th:block th:replace="~{fragments/sidebar :: sidebarScript}"></th:block>
    </div> <!-- End main-content -->
</body>
</html>
