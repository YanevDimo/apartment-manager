<!DOCTYPE html>
<html lang="bg" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Клиентска база</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
    <!-- Custom CSS -->
    <link href="/static/css/app.css" rel="stylesheet" />
    <!-- Sidebar Styles -->
    <th:block th:replace="~{fragments/sidebar :: sidebarStyles}"></th:block>
</head>
<body>
    <!-- Sidebar Toggle Button (Mobile) -->
    <th:block th:replace="~{fragments/sidebar :: sidebarToggle}"></th:block>
    
    <!-- Sidebar -->
    <th:block th:replace="~{fragments/sidebar :: sidebar}"></th:block>

    <!-- Main Content -->
    <div class="main-content" id="mainContent">
 <div>Клиентска база</div>

 <div>
<style>
 /* Modern table styling */
 .clients-table {
 border-collapse: separate;
 border-spacing: 0;
 }

 .clients-table thead th {
 background: #2b2d30;
 background: linear-gradient(180deg, #2b2d30 0%, #1f2023 100%);
 color: white;
 font-weight: 600;
 text-transform: uppercase;
 font-size: 0.75rem;
 letter-spacing: 0.5px;
 padding: 1rem 0.75rem;
 border: none;
 position: relative;
 }
 
 .clients-table thead th:first-child {
 border-top-left-radius: 0;
 }
 
 .clients-table thead th:last-child {
 border-top-right-radius: 0;
 }

 .clients-table tbody tr {
 transition: all 0.3s ease;
 background: white;
 border-bottom: 1px solid #e9ecef;
 }

 .clients-table tbody tr:hover {
 background: linear-gradient(90deg, #f8f9ff 0%, #ffffff 100%);
 box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
 transform: translateX(2px);
 }

 .clients-table tbody td {
 padding: 1rem 0.75rem;
 vertical-align: middle;
 border: none;
 }

 .client-name-link {
 color: #667eea;
 font-weight: 600;
 font-size: 1rem;
 text-decoration: none;
 transition: all 0.2s ease;
 display: inline-block;
 }

 .client-name-link:hover {
 color: #764ba2;
 transform: translateX(3px);
 }

 .client-id-badge {
 background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
 color: white;
 padding: 0.25rem 0.5rem;
 border-radius: 12px;
 font-size: 0.7rem;
 font-weight: 600;
 }

 .contact-link {
 color: #6c757d;
 text-decoration: none;
 font-size: 0.9rem;
 transition: all 0.2s ease;
 display: inline-flex;
 align-items: center;
 gap: 0.25rem;
 }

 .contact-link:hover {
 color: #667eea;
 }

 .contact-link i {
 font-size: 1rem;
 }

 /* Иконки за действия */
 .action-icon {
 font-size: 1.25rem;
 text-decoration: none;
 transition: all 0.2s ease-in-out;
 cursor: pointer;
 padding: 0.5rem;
 border-radius: 8px;
 display: inline-flex;
 align-items: center;
 justify-content: center;
 }

 .action-icon:hover {
 transform: translateY(-2px);
 text-decoration: none;
 box-shadow: 0 4px 8px rgba(0,0,0,0.15);
 }

 .icon-blue {
 color: #667eea !important;
 background: rgba(102, 126, 234, 0.1);
 }

 .icon-blue:hover {
 color: #764ba2 !important;
 background: rgba(102, 126, 234, 0.2) !important;
 }

 .icon-green {
 color: #28a745 !important;
 background: rgba(40, 167, 69, 0.1);
 }

 .icon-green:hover {
 color: #1e7e34 !important;
 background: rgba(40, 167, 69, 0.2) !important;
 }

 .icon-red {
 color: #dc3545 !important;
 background: rgba(220, 53, 69, 0.1);
 }

 .icon-red:hover {
 color: #bd2130 !important;
 background: rgba(220, 53, 69, 0.2) !important;
 }

 /* Стил за търсачката */
 .input-group-text {
 background-color: #f8f9fa;
 border-right: none;
 }

 .input-group .form-control {
 border-left: none;
 }

 .input-group .form-control:focus {
 border-left: none;
 box-shadow: none;
 }

 .input-group:focus-within .input-group-text {
 border-color: #86b7fe;
 background-color: #fff;
 }

 /* Card shadow */
 .card {
 box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
 border: none;
 }
</style>
<div class="container-fluid">
 <div class="row">
 <div class="col-md-12">
 <div class="d-flex justify-content-between align-items-center mb-4">
 <h2>
 <i class="bi bi-people"></i> Клиентска база
 </h2>
 <div>
 <a href="/add-client" class="btn btn-success me-2">
 <i class="bi bi-person-plus me-1"></i> Добави клиент
 </a>
 <a href="/export-clients" class="btn btn-outline-info">
 <i class="bi bi-file-earmark-excel me-1"></i> Експорт Excel
 </a>
 </div>
 </div>

 <!-- Търсене -->
 <div class="row mb-3">
 <div class="col-md-6">
 <form method="GET" class="d-flex" action="/clients">
 <div class="input-group">
 <span class="input-group-text">
 <i class="bi bi-search text-muted"></i>
 </span>
 <input type="text" name="search" class="form-control"
 placeholder="Търси по име, телефон или имейл..."
 />
 </div>
 <button type="submit" class="btn btn-primary ms-2">
 Търси
 </button>
 <a href="/clients" class="btn btn-outline-secondary ms-2" title="Изчисти търсенето">
 <i class="bi bi-x-circle"></i>
 </a>
 </form>
 </div>
                <div class="col-md-6 text-end">
                <small class="text-muted" id="client-count">
                Показани: <span id="client-count-value">0</span> клиента
                </small>
                </div>
 </div>

 <!-- Таблица с клиенти -->
 <div class="card">
 <div class="card-body p-0">
 <div class="table-responsive">
 <table class="table table-hover clients-table mb-0">
 <thead>
 <tr>
 <th style="width: 80px;">ID</th>
 <th>Клиент</th>
 <th style="width: 220px;">Контакти</th>
 <th style="width: 120px;" class="text-center">Действия</th>
 </tr>
 </thead>
 <tbody id="clients-tbody">
 <!-- Clients will be loaded here via JavaScript -->
 </tbody>
 </table>
 </div>
 </div>
 </div>
 </div>
 </div>
</div>

<!-- Modal за потвърждение на изтриване -->
<div class="modal fade" id="deleteModal" tabindex="-1">
 <div class="modal-dialog">
 <div class="modal-content">
 <div class="modal-header">
 <h5 class="modal-title">Потвърждение за изтриване</h5>
 <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
 </div>
 <div class="modal-body">
 <p>Сигурни ли сте, че искате да изтриете клиента <strong id="clientName"></strong>?</p>
 <div class="alert alert-warning">
 <i class="bi bi-exclamation-triangle"></i>
 Това действие не може да бъде отменено!
 </div>
 </div>
 <div class="modal-footer">
 <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отказ</button>
 <button type="button" id="confirmDeleteBtn" class="btn btn-danger">
 <i class="bi bi-trash"></i> Изтрий
 </button>
 </div>
 </div>
 </div>
</div>
 </div>

 <div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Load clients on page load
$(document).ready(function() {
    loadClients();
    
    // Get search term from URL if present
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get('search');
    if (searchTerm) {
        $('input[name="search"]').val(searchTerm);
    }
});

function loadClients() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchTerm = urlParams.get('search');
    
    let url = '/clients/api/list';
    if (searchTerm) {
        url = '/clients/api/search?q=' + encodeURIComponent(searchTerm);
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(response) {
            const clients = response.clients || [];
            populateTable(clients);
            // Update client count
            $('#client-count-value').text(clients.length);
        },
        error: function(xhr) {
            console.error('Error loading clients:', xhr);
            $('#clients-tbody').html('<tr><td colspan="6" class="text-center text-danger">Грешка при зареждане на клиентите</td></tr>');
        }
    });
}

function populateTable(clients) {
    const tbody = $('#clients-tbody');
    tbody.empty();
    
    if (clients.length === 0) {
        tbody.html('<tr><td colspan="4" class="text-center text-muted py-5">Няма намерени клиенти</td></tr>');
        return;
    }
    
    clients.forEach(function(client) {
        const phoneHtml = client.phone ? 
            `<div class="mb-1"><a href="tel:${escapeHtml(client.phone)}" class="contact-link"><i class="bi bi-telephone-fill"></i>${escapeHtml(client.phone)}</a></div>` : '';
        const emailHtml = client.email ? 
            `<div><a href="mailto:${escapeHtml(client.email)}" class="contact-link"><i class="bi bi-envelope-fill"></i>${escapeHtml(client.email)}</a></div>` : '';
        const contactsHtml = phoneHtml || emailHtml ? phoneHtml + emailHtml : '<span class="text-muted">-</span>';
        
        const row = `
            <tr>
                <td>
                    <span class="client-id-badge">#${client.id || ''}</span>
                </td>
                <td>
                    <a href="/clients/${client.id}" class="client-name-link">
                        <i class="bi bi-person-circle me-2"></i>${escapeHtml(client.name || '')}
                    </a>
                </td>
                <td>
                    ${contactsHtml}
                </td>
                <td>
                    <div class="d-flex gap-2 justify-content-center">
                        <a href="/clients/edit/${client.id}" class="action-icon icon-green" title="Редактиране">
                            <i class="bi bi-pencil-fill"></i>
                        </a>
                        <a href="#" class="action-icon icon-red delete-client-btn" 
                           data-client-id="${client.id}" 
                           data-client-name="${escapeHtml(client.name || '')}"
                           title="Изтриване">
                            <i class="bi bi-trash-fill"></i>
                        </a>
                    </div>
                </td>
            </tr>
        `;
        tbody.append(row);
    });
    
}


function escapeHtml(text) {
    if (!text) return '';
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.toString().replace(/[&<>"']/g, function(m) { return map[m]; });
}

function formatDate(dateString) {
    if (!dateString) return '-';
    try {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return day + '.' + month + '.' + year;
    } catch (e) {
        // If date parsing fails, try to extract date part from ISO string
        if (dateString.includes('T')) {
            return dateString.split('T')[0].split('-').reverse().join('.');
        }
        return dateString;
    }
}

function editClient(clientId) {
    window.location.href = '/clients/edit/' + clientId;
}

function confirmDelete(clientId, clientName) {
    // Проверяваме дали имаме валидни параметри
    if (!clientId || !clientName) {
        return;
    }

    // Задаваме името на клиента в модала
    var clientNameElement = document.getElementById('clientName');
    if (clientNameElement) {
        clientNameElement.textContent = clientName;
    }

    // Запазваме ID в бутона за потвърждение
    var confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    if (confirmDeleteBtn) {
        confirmDeleteBtn.setAttribute('data-client-id', clientId);
    } else {
        return;
    }

    // Показваме модала
    var deleteModalElement = document.getElementById('deleteModal');
    if (deleteModalElement) {
        var deleteModal = new bootstrap.Modal(deleteModalElement);
        deleteModal.show();
    }
}

// Единствен делегиран handler за delete бутон
$(document).on('click', '.delete-client-btn', function(e) {
    e.preventDefault();
    const clientId = $(this).data('client-id');
    const clientName = $(this).data('client-name');
    confirmDelete(clientId, clientName);
});

// Единствен handler за потвърждение
$(document).on('click', '#confirmDeleteBtn', function() {
    const clientId = $(this).attr('data-client-id');
    if (clientId) {
        deleteClient(clientId);
    }
});

// Function to delete client via API
function deleteClient(clientId) {
 $.ajax({
 url: '/clients/api/delete/' + clientId,
 method: 'DELETE',
 success: function(response) {
 if (response.success) {
 $('#deleteModal').modal('hide');
 loadClients(); // Reload clients after deletion
 alert('Клиентът е изтрит успешно');
 } else {
 alert('Грешка: ' + (response.message || 'Неуспешно изтриване'));
 }
 },
 error: function(xhr) {
 let errorMessage = 'Грешка при изтриване';
 if (xhr.responseJSON && xhr.responseJSON.message) {
 errorMessage = xhr.responseJSON.message;
 }
 alert(errorMessage);
 }
 });
}
</script>
    
    <!-- Sidebar Script -->
    <th:block th:replace="~{fragments/sidebar :: sidebarScript}"></th:block>
    </div> <!-- End main-content -->
</body>
</html>
